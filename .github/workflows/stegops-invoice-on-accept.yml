name: StegOps Invoice on ACCEPT

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  invoice-on-accept:
    runs-on: ubuntu-latest

    steps:
      - name: Gate + Determine pricing (from ACCEPT comment, fallback to issue body)
        id: gate
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) { core.setOutput("proceed", "false"); return; }

            const commentRaw = (context.payload.comment?.body || "").trim();
            const comment = commentRaw.toLowerCase();

            const accept = /^(accept|accepted|i accept)\b/.test(comment);
            const labels = (issue.labels || []).map(l => l.name);

            const stegops = labels.includes("stegops");
            const qualified = labels.includes("qualified");
            const sowGenerated = labels.includes("sow-generated");
            const invoiceGenerated = labels.includes("invoice-generated");

            if (!(accept && stegops && qualified && sowGenerated && !invoiceGenerated)) {
              core.setOutput("proceed", "false");
              return;
            }

            // Optional explicit amount in ACCEPT comment: "amount 3500" or "amount: 3500"
            let amountOverride = null;
            const m = comment.match(/\bamount\b\s*[:=]?\s*\$?\s*([0-9]{2,6})\b/);
            if (m) amountOverride = parseInt(m[1], 10);

            // Determine service from issue body (dropdown selection)
            let service = null; // "monthly" | "audit"
            const body = (issue.body || "").toLowerCase();
            if (body.includes("monthly ops support")) service = "monthly";
            if (body.includes("one-time ai ops audit")) service = "audit";
            if (!service) service = "audit";

            let serviceName = "";
            let amount = "";

            if (service === "monthly") {
              serviceName = "Monthly Ops Support";
              amount = amountOverride ? `$${amountOverride} USD / month` : "$99 / month";
            } else {
              serviceName = "One-time AI Ops Audit";
              amount = amountOverride ? `$${amountOverride} USD` : "$2,500 USD";
            }

            core.setOutput("proceed", "true");
            core.setOutput("service_name", serviceName);
            core.setOutput("amount_usd", amount);

      - name: Stop if not applicable
        if: steps.gate.outputs.proceed != 'true'
        run: echo "Not an ACCEPT invoice event."

      - name: Ensure label exists
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function ensureLabel(name, color, description) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name, color, description });
                } else {
                  throw e;
                }
              }
            }

            await ensureLabel("invoice-generated", "0052cc", "Invoice has been generated for this engagement.");

      - name: Checkout repo
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/checkout@v4

      - name: Generate invoice file
        if: steps.gate.outputs.proceed == 'true'
        run: |
          set -euo pipefail
          mkdir -p invoices

          ISSUE_NUMBER="${{ github.event.issue.number }}"
          AUTHOR="${{ github.event.issue.user.login }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"

          DATE_UTC="$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          DATE_TAG="$(date -u '+%Y%m%d')"
          INVOICE_ID="INV-${ISSUE_NUMBER}-${DATE_TAG}-FINAL"

          SOW_PATH="leads/issue-${ISSUE_NUMBER}/SOW_DRAFT.md"

          SERVICE_NAME="${{ steps.gate.outputs.service_name }}"
          AMOUNT_USD="${{ steps.gate.outputs.amount_usd }}"

          TEMPLATE="templates/invoice_final.md"
          OUT="invoices/${INVOICE_ID}.md"

          sed \
            -e "s|{{INVOICE_ID}}|${INVOICE_ID}|g" \
            -e "s|{{DATE_UTC}}|${DATE_UTC}|g" \
            -e "s|{{AUTHOR}}|${AUTHOR}|g" \
            -e "s|{{ISSUE_URL}}|${ISSUE_URL}|g" \
            -e "s|{{ISSUE_TITLE}}|${ISSUE_TITLE}|g" \
            -e "s|{{SOW_PATH}}|${SOW_PATH}|g" \
            -e "s|{{SERVICE_NAME}}|${SERVICE_NAME}|g" \
            -e "s|{{AMOUNT_USD}}|${AMOUNT_USD}|g" \
            "$TEMPLATE" > "$OUT"

          echo "Wrote $OUT"

      - name: Commit invoice
        if: steps.gate.outputs.proceed == 'true'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "steg-ops-orchestrator-bot"
            git config user.email "steg-ops-orchestrator-bot@users.noreply.github.com"
            git add invoices/
            git commit -m "Invoices: generate invoice on ACCEPT for issue #${{ github.event.issue.number }}"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Label invoice-generated
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["invoice-generated"]
            });

      - name: Comment invoice link
        if: steps.gate.outputs.proceed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const n = context.issue.number;
            const dateTag = new Date().toISOString().slice(0,10).replaceAll('-','');
            const invoiceId = `INV-${n}-${dateTag}-FINAL`;
            const path = `invoices/${invoiceId}.md`;
            const url = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/${path}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: n,
              body: `âœ… **Invoice generated**: ${url}\n\nReply **PAID** once payment is completed, or request a payment link/method.`
            });
