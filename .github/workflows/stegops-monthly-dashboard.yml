name: StegOps Monthly Dashboard

on:
  schedule:
    - cron: "23 10 1 * *" # 1st of every month @ 10:23 UTC
  workflow_dispatch: {}

permissions:
  contents: write
  issues: read

jobs:
  dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build dashboard from GitHub issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            async function count(query) {
              const q = `repo:${owner}/${repo} is:issue ${query}`;
              const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 1 });
              return res.data.total_count;
            }

            const ts = new Date().toISOString();
            const ym = ts.slice(0,7); // YYYY-MM

            const openStegops = await count("is:open label:stegops");
            const openQualified = await count("is:open label:stegops label:qualified");
            const openUnqualified = await count("is:open label:stegops -label:qualified");
            const closedNoResponse = await count("is:closed label:stegops label:no-response");
            const totalStegops = await count("label:stegops");

            const md = `# StegOps Dashboard

**Generated (UTC):** ${ts}

## Pipeline
- Total StegOps issues: **${totalStegops}**
- Open StegOps issues: **${openStegops}**
- Open qualified leads: **${openQualified}**
- Open unqualified (waiting): **${openUnqualified}**
- Closed as no-response: **${closedNoResponse}**

## Notes
- This dashboard is auto-generated monthly.
- Leads are qualified by commenting **YES**.
- Draft invoices are generated by commenting **invoice** on a qualified issue.

`;

            fs.mkdirSync("dashboards", { recursive: true });
            fs.writeFileSync("dashboards/DASHBOARD.md", md, "utf8");
            fs.writeFileSync(`dashboards/monthly-${ym}.md`, md, "utf8");

      - name: Commit dashboards
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "steg-ops-orchestrator-bot"
            git config user.email "steg-ops-orchestrator-bot@users.noreply.github.com"
            git add dashboards/
            git commit -m "Dashboard: monthly update"
            git push
          else
            echo "No changes to commit."
          fi
